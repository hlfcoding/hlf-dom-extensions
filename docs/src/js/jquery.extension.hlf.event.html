<!DOCTYPE html><html lang="en"><head><title>src/js/jquery.extension.hlf.event</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/js/jquery.extension.hlf.event"><meta name="groc-project-path" content="src/js/jquery.extension.hlf.event.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/js/jquery.extension.hlf.event.coffee</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="hlf-event-jquery-extension">HLF Event jQuery Extension</h1>

<p>Released under the MIT License <br />
Written with jQuery 1.7.2  </p></div></div><div class="code"><div class="wrapper"><span class="c1">#!For working docs generation, disable automatic trailing whitespace trimming.</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This extension adds custom events to jQuery. It general, the process is
composed of three parts:</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ol>
<li>Extend main namespace with properties to store global state.</li>
<li>Private functions to implement certain behaviors.</li>
<li>Adapting the behaviors to custom events.</li>
</ol></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Export. Prefer AMD. Note that we don't actually provide any exports because
ours are attached to jQuery.</p></div></div><div class="code"><div class="wrapper"><span class="p">(</span><span class="nf">(extension) -&gt;</span>
  <span class="k">if</span> <span class="nx">define</span><span class="o">?</span> <span class="o">and</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="o">?</span>
    <span class="nx">define</span> <span class="p">[</span>
      <span class="s">&#39;jquery&#39;</span>
      <span class="s">&#39;underscore&#39;</span>
      <span class="s">&#39;hlf/jquery.extension.hlf.core&#39;</span>
    <span class="p">],</span> <span class="nx">extension</span>
  <span class="k">else</span> <span class="nx">extension</span> <span class="nx">jQuery</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">hlf</span>
<span class="p">)(</span><span class="nf">($, _, hlf) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="i-hover-intent">I. Hover-Intent</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A set of custom events based on a distance check with a customizable
<code>interval</code> of delay to limit 'un-intentional' mouse-enter's and mouse-
leave's. Allows for customization based on <code>sensitivity</code> to movement.</p></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Also, unlike the jQuery <code>mouseenter</code> and <code>mouseleave</code> events,
<code>truemouseenter</code> and <code>truemouseleave</code> provide <code>pageX</code> and <code>pageY</code> values.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">hlf</span><span class="p">,</span>
    <span class="nv">hoverIntent:</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Switch for debugging just hover intent. </p></div></div><div class="code"><div class="wrapper">      <span class="nv">debug: </span><span class="kc">off</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Stores the global state of the mouse. This is for public use.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">mouse:</span>
        <span class="nv">x:</span>
          <span class="nv">current: </span><span class="mi">0</span>
          <span class="nv">previous: </span><span class="mi">0</span>
        <span class="nv">y:</span>
          <span class="nv">current: </span><span class="mi">0</span>
          <span class="nv">previous: </span><span class="mi">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Default options.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">sensitivity: </span><span class="mi">8</span>
      <span class="nv">interval: </span><span class="mi">300</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>To get the name of this set of custom events, just use the <code>toString</code>
function and pass the appropriate context. Note we're memoizing it.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">toString: </span><span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span> <span class="nf">(context) -&gt;</span>
        <span class="k">switch</span> <span class="nx">context</span>
          <span class="k">when</span> <span class="s">&#39;attr&#39;</span> <span class="k">then</span> <span class="s">&#39;hlf-hover-intent&#39;</span>
          <span class="k">else</span> <span class="s">&#39;hlf.hoverIntent&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Alias and don't pollute the extension scope.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">do</span> <span class="nf">(hoverIntent = hlf.hoverIntent, mouse = hlf.hoverIntent.mouse) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>attr</code> is an internal formatter for attribute names,
mainly those of jQuery data keys.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">attr = </span><span class="nf">(name=&#39;&#39;) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">hoverIntent</span><span class="p">.</span><span class="nx">toString</span> <span class="s">&#39;attr&#39;</span><span class="si">}</span><span class="s">-</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>debugLog</code> is our internal logger. It's optimized to be a noop if
hover intent debugging is off.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">debugLog = </span><span class="k">if</span> <span class="nx">hoverIntent</span><span class="p">.</span><span class="nx">debug</span> <span class="o">is</span> <span class="kc">off</span> <span class="k">then</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span> <span class="k">else</span>
      <span class="nf">-&gt;</span> <span class="nx">hlf</span><span class="p">.</span><span class="nx">debugLog</span> <span class="nx">hoverIntent</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The internals of hover intent is about tracking the state of the trigger
element's interaction with the mouse.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>With <code>defaultState</code>, we start with <code>intentional</code> to yes, so the first
interaction is always successful. <code>timer</code> is also set to an empty state,
which tells us the timer is inactive. <code>sensitivity</code> and <code>interval</code> are
stored here, so they can be customized to be trigger-specific, and they
both default to the default extension options.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">defaultState =</span>
      <span class="nv">intentional: </span><span class="kc">yes</span>
      <span class="nv">timer: </span><span class="p">{</span> <span class="nv">cleared: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">timeout: </span><span class="kc">null</span> <span class="p">}</span>
      <span class="nv">sensitivity: </span><span class="nx">hoverIntent</span><span class="p">.</span><span class="nx">sensitivity</span>
      <span class="nv">interval: </span><span class="nx">hoverIntent</span><span class="p">.</span><span class="nx">interval</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>getComputedState</code> simplifies getting the trigger element's hover intent
state and using any <code>defaultState</code> as fallback. Note that we clone the
value if it looks like it will be assigned by reference.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">getComputedState = </span><span class="nf">($trigger) -&gt;</span>
      <span class="nv">state = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="k">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">defaultState</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isPlainObject</span> <span class="nx">value</span> <span class="k">then</span> <span class="nv">value = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">value</span>
        <span class="nx">state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$trigger</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">attr</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="o">or</span> <span class="nx">value</span>
      <span class="nx">state</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>check</code> is the main routine that uses the state, setup, and teardown
subroutines. It is an event handler (see below).</p></div></div><div class="code"><div class="wrapper">    <span class="nv">check = </span><span class="nf">(event) -&gt;</span>
      <span class="nv">$trigger = </span><span class="nx">$</span> <span class="nx">@</span>
      <span class="nv">state = </span><span class="nx">getComputedState</span> <span class="nx">$trigger</span>
      <span class="nx">debugLog</span> <span class="nx">state</span>
      <span class="nv">didTeardown = </span><span class="nx">teardownCheckIfNeeded</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">$trigger</span><span class="p">,</span> <span class="nx">state</span>
      <span class="k">if</span> <span class="nx">didTeardown</span> <span class="o">is</span> <span class="kc">no</span> <span class="k">then</span> <span class="nx">setupCheckIfNeeded</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">$trigger</span><span class="p">,</span> <span class="nx">state</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>setupCheckIfNeeded</code> will setup to <code>performCheck</code> after setting up (again)
the timer state, but only if the timer state is properly reset.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupCheckIfNeeded = </span><span class="nf">(event, $trigger, state) -&gt;</span>
      <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">cleared</span> <span class="o">is</span> <span class="kc">no</span> <span class="o">and</span> <span class="nx">state</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">timeout</span><span class="o">?</span>
      <span class="nx">debugLog</span> <span class="s">&#39;setup&#39;</span>
      <span class="nv">state.timer.timeout = </span><span class="nx">setTimeout</span> <span class="nf">-&gt;</span>
        <span class="nx">debugLog</span> <span class="s">&#39;check and update&#39;</span>
        <span class="nx">performCheck</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">$trigger</span><span class="p">,</span> <span class="nx">state</span>
      <span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">interval</span>
      <span class="nv">state.timer.cleared = </span><span class="kc">no</span>
      <span class="nx">$trigger</span><span class="p">.</span><span class="nx">data</span> <span class="nx">attr</span><span class="p">(</span><span class="s">&#39;timer&#39;</span><span class="p">),</span> <span class="nx">state</span><span class="p">.</span><span class="nx">timer</span>
      <span class="k">return</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>teardownCheckIfNeeded</code> will teardown by removing state from trigger data,
thereby defaulting them (see <code>getComputedState</code>). It will only work on
mouse-leave and will always trigger <code>truemouseleave</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">teardownCheckIfNeeded = </span><span class="nf">(event, $trigger, state) -&gt;</span>
      <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span> <span class="o">isnt</span> <span class="s">&#39;mouseleave&#39;</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">cleared</span> <span class="o">is</span> <span class="kc">no</span>
        <span class="nx">debugLog</span> <span class="s">&#39;teardown&#39;</span>
        <span class="nx">clearTimeout</span> <span class="nx">state</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">timeout</span>
        <span class="nx">$trigger</span>
          <span class="p">.</span><span class="nx">removeData</span> <span class="nx">attr</span><span class="p">(</span><span class="s">&#39;timer&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">removeData</span> <span class="nx">attr</span><span class="p">(</span><span class="s">&#39;intentional&#39;</span><span class="p">)</span>
      <span class="nx">triggerEvent</span> <span class="s">&#39;truemouseleave&#39;</span><span class="p">,</span> <span class="nx">$trigger</span>
      <span class="k">return</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>performCheck</code> is the main hover intent checking subroutine. The state's
<code>intentional</code> flag is updated as a crude change-in-distance comparison. If
there is intent, then <code>truemouseenter</code> is triggered. The timer is reset,
since this completes the checking cycle. State is also always saved to the
trigger.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">performCheck = </span><span class="nf">(event, $trigger, state) -&gt;</span>
      <span class="nv">state.intentional =</span>
        <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">mouse</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">previous</span> <span class="o">-</span> <span class="nx">mouse</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span> <span class="o">+</span>
         <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">mouse</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">previous</span> <span class="o">-</span> <span class="nx">mouse</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">current</span><span class="p">))</span> <span class="o">&gt;</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">sensitivity</span>
      <span class="nv">mouse.x.previous = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span>
      <span class="nv">mouse.y.previous = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span>
      <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">intentional</span> <span class="o">is</span> <span class="kc">yes</span> <span class="o">and</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;mouseover&#39;</span>
        <span class="nx">triggerEvent</span> <span class="s">&#39;truemouseenter&#39;</span><span class="p">,</span> <span class="nx">$trigger</span>
      <span class="nv">state.timer.cleared = </span><span class="kc">yes</span>
      <span class="nx">$trigger</span><span class="p">.</span><span class="nx">data</span> <span class="nx">attr</span><span class="p">(</span><span class="s">&#39;intentional&#39;</span><span class="p">),</span> <span class="nx">state</span><span class="p">.</span><span class="nx">intentional</span>
      <span class="nx">$trigger</span><span class="p">.</span><span class="nx">data</span> <span class="nx">attr</span><span class="p">(</span><span class="s">&#39;timer&#39;</span><span class="p">),</span> <span class="nx">state</span><span class="p">.</span><span class="nx">timer</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>trackMouse</code> tracks mouse position specifically for checking hover intent.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">trackMouse = </span><span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span> <span class="nf">(event) -&gt;</span>
      <span class="nv">mouse.x.current = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span>
      <span class="nv">mouse.y.current = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span>
    <span class="p">,</span> <span class="mi">16</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>triggerEvent</code> abstracts away the generation of and support for custom
hover intent events.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">triggerEvent = </span><span class="nf">(name, $trigger) -&gt;</span>
      <span class="k">switch</span> <span class="nx">name</span>
        <span class="k">when</span> <span class="s">&#39;truemouseenter&#39;</span> <span class="k">then</span> <span class="nv">event =</span>
          <span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Event</span> <span class="nx">name</span><span class="p">,</span> <span class="p">{</span> <span class="nv">pageX: </span><span class="nx">mouse</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nv">pageY: </span><span class="nx">mouse</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">current</span> <span class="p">}</span>
        <span class="k">when</span> <span class="s">&#39;truemouseleave&#39;</span> <span class="k">then</span> <span class="nv">event = </span><span class="nx">name</span>
        <span class="k">else</span> <span class="nv">event = </span><span class="kc">null</span>
      <span class="k">if</span> <span class="nx">event</span><span class="o">?</span>
        <span class="nx">debugLog</span> <span class="nx">name</span>
        <span class="nx">$trigger</span><span class="p">.</span><span class="nx">trigger</span> <span class="nx">event</span>
      <span class="k">else</span> <span class="k">return</span> <span class="kc">no</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Lastly, we register our custom jQuery events, essentially wrapping our
binding over binding to <code>mouseover</code>, <code>mousemove</code>, and <code>mouseleave</code>. We're
not using <code>mouseenter</code>, since its detection mechanism conflicts with hover
intent's.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">$.event.special.truemouseenter =</span>
      <span class="nv">setup: </span><span class="nf">(data, namespaces) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">on</span>  <span class="p">{</span> <span class="nv">mouseover: </span><span class="nx">check</span><span class="p">,</span> <span class="nv">mousemove: </span><span class="nx">trackMouse</span> <span class="p">},</span>
          <span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">selector</span>
      <span class="nv">teardown: </span><span class="nf">(data, namespaces) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">off</span> <span class="p">{</span> <span class="nv">mouseover: </span><span class="nx">check</span><span class="p">,</span> <span class="nv">mousemove: </span><span class="nx">trackMouse</span> <span class="p">},</span>
          <span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">selector</span>

    <span class="nv">$.event.special.truemouseleave =</span>
      <span class="nv">setup: </span><span class="nf">(data, namespaces) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">on</span>  <span class="p">{</span> <span class="nv">mouseleave: </span><span class="nx">check</span> <span class="p">},</span>
          <span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">selector</span>
      <span class="nv">teardown: </span><span class="nf">(data, namespaces) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">off</span> <span class="p">{</span> <span class="nv">mouseleave: </span><span class="nx">check</span> <span class="p">},</span>
          <span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">selector</span>

<span class="p">)</span></div></div></div></div></body></html>