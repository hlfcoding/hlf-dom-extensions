<!DOCTYPE html><html lang="en"><head><title>src/js/jquery.extension.hlf.event</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/js/jquery.extension.hlf.event"><meta name="groc-project-path" content="src/js/jquery.extension.hlf.event.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/js/jquery.extension.hlf.event.coffee</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="hlf-event-jquery-extension">HLF Event jQuery Extension</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This extension adds custom events to jQuery. It general, the process is
composed of three parts:</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ol>
<li>Extend main namespace with properties to store global state.</li>
<li>Private functions to implement certain behaviors.</li>
<li>Adapting the behaviors to custom events.</li>
</ol></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>‚ùß</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Export. Support AMD, CommonJS (Browserify), and browser globals.</p></div></div><div class="code"><div class="wrapper">(<span class="hljs-function"><span class="hljs-params">(root, factory)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> define <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">and</span> define.amd?</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>AMD. Register as an anonymous module.</li>
</ul></div></div><div class="code"><div class="wrapper">    define [
      <span class="hljs-string">'jquery'</span>
      <span class="hljs-string">'underscore'</span>
      <span class="hljs-string">'hlf/jquery.extension.hlf.core'</span>
    ], factory
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> exports <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Node. Does not work with strict CommonJS, but only CommonJS-like
environments that support module.exports, like Node.</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">module</span>.exports = factory(
      <span class="hljs-built_in">require</span> <span class="hljs-string">'jquery'</span>,
      <span class="hljs-built_in">require</span> <span class="hljs-string">'underscore'</span>,
      <span class="hljs-built_in">require</span> <span class="hljs-string">'hlf/jquery.extension.hlf.core'</span>
    )
  <span class="hljs-keyword">else</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Browser globals (root is window). No globals needed.</li>
</ul></div></div><div class="code"><div class="wrapper">    factory jQuery, _, jQuery.hlf
)(@, <span class="hljs-function"><span class="hljs-params">($, _, hlf)</span> -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>‚ùß</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="hover-intent">Hover-Intent</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A set of custom events based on a distance check with a customizable
<code>interval</code> of delay to limit &#39;un-intentional&#39; mouse-enter&#39;s and mouse-
leave&#39;s. Allows for customization based on <code>sensitivity</code> to movement.</p></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Also, unlike the jQuery <code>mouseenter</code> and <code>mouseleave</code> events,
<code>truemouseenter</code> and <code>truemouseleave</code> provide <code>pageX</code> and <code>pageY</code> values.</p></div></div><div class="code"><div class="wrapper">  $.extend <span class="hljs-literal">true</span>, hlf,
    <span class="hljs-attribute">hoverIntent</span>:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Switch for debugging just hover intent.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="hljs-attribute">debug</span>: <span class="hljs-literal">off</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Stores the global state of the mouse. This is for public use.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="hljs-attribute">mouse</span>:
        <span class="hljs-attribute">x</span>:
          <span class="hljs-attribute">current</span>: <span class="hljs-number">0</span>
          <span class="hljs-attribute">previous</span>: <span class="hljs-number">0</span>
        <span class="hljs-attribute">y</span>:
          <span class="hljs-attribute">current</span>: <span class="hljs-number">0</span>
          <span class="hljs-attribute">previous</span>: <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Default options.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="hljs-attribute">sensitivity</span>: <span class="hljs-number">8</span>
      <span class="hljs-attribute">interval</span>: <span class="hljs-number">300</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>To get the name of this set of custom events, just use the <code>toString</code>
function and pass the appropriate context. Note we&#39;re memoizing it.</li>
</ul></div></div><div class="code"><div class="wrapper">      <span class="hljs-attribute">toString</span>: _.memoize (context) -&gt;
        <span class="hljs-keyword">switch</span> context
          <span class="hljs-keyword">when</span> <span class="hljs-string">'attr'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'hlf-hover-intent'</span>
          <span class="hljs-keyword">else</span> <span class="hljs-string">'hlf.hoverIntent'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Alias and don&#39;t pollute the extension scope.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">do</span> (hoverIntent = hlf.hoverIntent, mouse = hlf.hoverIntent.mouse) -&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>attr</code> is an internal formatter for attribute names,
mainly those of jQuery data keys.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">attr</span> = <span class="hljs-params">(name=<span class="hljs-string">''</span>)</span> -&gt;</span> <span class="hljs-string">"<span class="hljs-subst">#{hoverIntent.toString <span class="hljs-string">'attr'</span>}</span>-<span class="hljs-subst">#{name}</span>"</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>debugLog</code> is our internal logger. It&#39;s optimized to be a noop if
hover intent debugging is off.</p></div></div><div class="code"><div class="wrapper">    debugLog = <span class="hljs-keyword">if</span> hoverIntent.debug <span class="hljs-keyword">is</span> <span class="hljs-literal">off</span> <span class="hljs-keyword">then</span> $.noop <span class="hljs-keyword">else</span>
      -&gt; hlf.debugLog hoverIntent.toString(<span class="hljs-string">'log'</span>), arguments...</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The internals of hover intent is about tracking the state of the trigger
element&#39;s interaction with the mouse.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>With <code>defaultState</code>, we start with <code>intentional</code> to yes, so the first
interaction is always successful. <code>timer</code> is also set to an empty state,
which tells us the timer is inactive. <code>sensitivity</code> and <code>interval</code> are
stored here, so they can be customized to be trigger-specific, and they
both default to the default extension options.</p></div></div><div class="code"><div class="wrapper">    defaultState =
      <span class="hljs-attribute">intentional</span>: <span class="hljs-literal">yes</span>
      <span class="hljs-attribute">timer</span>: { <span class="hljs-attribute">cleared</span>: <span class="hljs-literal">yes</span>, <span class="hljs-attribute">timeout</span>: <span class="hljs-literal">null</span> }
      <span class="hljs-attribute">sensitivity</span>: hoverIntent.sensitivity
      <span class="hljs-attribute">interval</span>: hoverIntent.interval</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>getComputedState</code> simplifies getting the trigger element&#39;s hover intent
state and using any <code>defaultState</code> as fallback. Note that we clone the
value if it looks like it will be assigned by reference.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">getComputedState</span> = <span class="hljs-params">($trigger)</span> -&gt;</span>
      state = {}
      <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> defaultState
        <span class="hljs-keyword">if</span> $.isPlainObject value <span class="hljs-keyword">then</span> value = _.clone value
        state[key] = $trigger.data(attr(key)) <span class="hljs-keyword">or</span> value
      state</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>check</code> is the main routine that uses the state, setup, and teardown
subroutines. It is an event handler (see below).</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">check</span> = <span class="hljs-params">(event)</span> -&gt;</span>
      $trigger = $ @
      state = getComputedState $trigger
      debugLog state
      didTeardown = teardownCheckIfNeeded event, $trigger, state
      <span class="hljs-keyword">if</span> didTeardown <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span> <span class="hljs-keyword">then</span> setupCheckIfNeeded event, $trigger, state</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>setupCheckIfNeeded</code> will setup to <code>performCheck</code> after setting up (again)
the timer state, but only if the timer state is properly reset.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">setupCheckIfNeeded</span> = <span class="hljs-params">(event, $trigger, state)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">no</span> <span class="hljs-keyword">if</span> state.timer.cleared <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span> <span class="hljs-keyword">and</span> state.timer.timeout?
      debugLog <span class="hljs-string">'setup'</span>
      state.timer.timeout = setTimeout -&gt;
        debugLog <span class="hljs-string">'check and update'</span>
        performCheck event, $trigger, state
      , state.interval
      state.timer.cleared = <span class="hljs-literal">no</span>
      $trigger.data attr(<span class="hljs-string">'timer'</span>), state.timer
      <span class="hljs-keyword">return</span> <span class="hljs-literal">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>teardownCheckIfNeeded</code> will teardown by removing state from trigger data,
thereby defaulting them (see <code>getComputedState</code>). It will only work on
mouse-leave and will always trigger <code>truemouseleave</code>.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">teardownCheckIfNeeded</span> = <span class="hljs-params">(event, $trigger, state)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">no</span> <span class="hljs-keyword">if</span> event.type <span class="hljs-keyword">isnt</span> <span class="hljs-string">'mouseleave'</span>
      <span class="hljs-keyword">if</span> state.timer.cleared <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        debugLog <span class="hljs-string">'teardown'</span>
        clearTimeout state.timer.timeout
        $trigger
          .removeData attr(<span class="hljs-string">'timer'</span>)
          .removeData attr(<span class="hljs-string">'intentional'</span>)
      triggerEvent <span class="hljs-string">'truemouseleave'</span>, $trigger, event
      <span class="hljs-keyword">return</span> <span class="hljs-literal">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>performCheck</code> is the main hover intent checking subroutine. The state&#39;s
<code>intentional</code> flag is updated as a crude change-in-distance comparison. If
there is intent, then <code>truemouseenter</code> is triggered. The timer is reset,
since this completes the checking cycle. State is also always saved to the
trigger.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">performCheck</span> = <span class="hljs-params">(event, $trigger, state)</span> -&gt;</span>
      state.intentional =
        (Math.abs(mouse.x.previous - mouse.x.current) +
         Math.abs(mouse.y.previous - mouse.y.current)) &gt;
        state.sensitivity
      mouse.x.previous = event.pageX
      mouse.y.previous = event.pageY
      <span class="hljs-keyword">if</span> state.intentional <span class="hljs-keyword">is</span> <span class="hljs-literal">yes</span> <span class="hljs-keyword">and</span> event.type <span class="hljs-keyword">is</span> <span class="hljs-string">'mouseover'</span>
        triggerEvent <span class="hljs-string">'truemouseenter'</span>, $trigger, event
      state.timer.cleared = <span class="hljs-literal">yes</span>
      $trigger.data attr(<span class="hljs-string">'intentional'</span>), state.intentional
      $trigger.data attr(<span class="hljs-string">'timer'</span>), state.timer</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>trackMouse</code> tracks mouse position specifically for checking hover intent.</p></div></div><div class="code"><div class="wrapper">    trackMouse = _.throttle (event) -&gt;
      mouse.x.current = event.pageX
      mouse.y.current = event.pageY
    , <span class="hljs-number">16</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ùíá <code>triggerEvent</code> abstracts away the generation of and support for custom
hover intent events.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">    <span class="hljs-title">triggerEvent</span> = <span class="hljs-params">(name, $trigger, oldEvent)</span> -&gt;</span>
      event = <span class="hljs-keyword">new</span> $.Event name, 
        <span class="hljs-attribute">pageX</span>: mouse.x.current
        <span class="hljs-attribute">pageY</span>: mouse.y.current
        <span class="hljs-attribute">relatedTarget</span>: oldEvent.relatedTarget
      debugLog name
      $trigger.trigger event</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Lastly, we register our custom jQuery events, essentially wrapping our
binding over binding to <code>mouseover</code>, <code>mousemove</code>, and <code>mouseleave</code>. We&#39;re
not using <code>mouseenter</code>, since its detection mechanism conflicts with hover
intent&#39;s.</p></div></div><div class="code"><div class="wrapper">    $.event.special.truemouseenter =
      <span class="hljs-attribute">setup</span>: <span class="hljs-function"><span class="hljs-params">(data, namespaces)</span> -&gt;</span>
        $(@).<span class="hljs-literal">on</span>  { <span class="hljs-attribute">mouseover</span>: check, <span class="hljs-attribute">mousemove</span>: trackMouse },
          data?.selector
      <span class="hljs-attribute">teardown</span>: <span class="hljs-function"><span class="hljs-params">(data, namespaces)</span> -&gt;</span>
        $(@).<span class="hljs-literal">off</span> { <span class="hljs-attribute">mouseover</span>: check, <span class="hljs-attribute">mousemove</span>: trackMouse },
          data?.selector

    $.event.special.truemouseleave =
      <span class="hljs-attribute">setup</span>: <span class="hljs-function"><span class="hljs-params">(data, namespaces)</span> -&gt;</span>
        $(@).<span class="hljs-literal">on</span>  { <span class="hljs-attribute">mouseleave</span>: check },
          data?.selector
      <span class="hljs-attribute">teardown</span>: <span class="hljs-function"><span class="hljs-params">(data, namespaces)</span> -&gt;</span>
        $(@).<span class="hljs-literal">off</span> { <span class="hljs-attribute">mouseleave</span>: check },
          data?.selector

)</div></div></div></div></body></html>